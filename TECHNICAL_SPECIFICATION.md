# Техническое Задание: GramChat

## 1. Общее описание проекта

### 1.1 Назначение системы
GramChat - это платформа для управления клиентской поддержкой через Telegram-ботов, позволяющая бизнесу централизованно обрабатывать обращения клиентов через веб-интерфейс.

### 1.2 Основные цели
- Централизация всех диалогов из Telegram в единой веб-панели
- Распределение диалогов между менеджерами
- Аналитика эффективности работы команды
- Контроль качества обслуживания клиентов

## 2. Функциональные требования

### 2.1 Система аутентификации и авторизации

#### 2.1.1 Вход в систему
- Аутентификация через Telegram-бота @gramchatauth_bot
- Генерация уникального кода для входа
- JWT токены для сессий
- Автоматический выход через 7 дней неактивности

#### 2.1.2 Роли пользователей
- **ADMIN** - полный доступ ко всем функциям системы
- **OWNER** - владелец магазина, управление командой
- **MANAGER** - менеджер, работа с диалогами

#### 2.1.3 Система инвайт-кодов ✨ NEW
- Создание инвайт-кодов для регистрации менеджеров
- Типы кодов: SINGLE (одноразовый), MULTI (многоразовый), PARTNER
- Ограничение срока действия кодов
- Отслеживание использования кодов

### 2.2 Управление магазинами (Shop)

#### 2.2.1 Создание магазина
- Указание названия магазина
- Привязка Telegram-бота (токен)
- Автоматическая проверка валидности токена
- Нормализация username бота

#### 2.2.2 Управление магазином
- Активация/деактивация магазина
- Изменение настроек бота
- Просмотр статистики магазина
- Одобрение магазина администратором

### 2.3 Система диалогов

#### 2.3.1 Обработка сообщений
- Автоматический импорт сообщений из Telegram
- Поддержка всех типов медиа:
  - Текстовые сообщения
  - Фотографии ✨ NEW
  - Видео ✨ NEW
  - Документы ✨ NEW
  - Голосовые сообщения ✨ NEW
  - Геолокация ✨ NEW
- Отображение аватарок клиентов
- Хранение истории переписки

#### 2.3.2 Статусы диалогов
- **NEW** - новый диалог
- **ACTIVE** - активный диалог
- **CLOSED** - закрытый диалог
  - DEAL - успешная сделка
  - CANCELLED - отмена

#### 2.3.3 Назначение диалогов ✨ NEW
- Кнопка "Взять себе" для свободных диалогов
- Кнопка "Освободить" для собственных диалогов
- Автоматическое обновление интерфейса при изменениях
- Передача диалога другому менеджеру

### 2.4 Система аналитики ✨ NEW

#### 2.4.1 Персональная аналитика
- Количество диалогов (всего, сделки, отмены)
- Конверсия в сделки
- Среднее время ответа
- Активные диалоги

#### 2.4.2 Сравнительная аналитика
- Рейтинг менеджеров по эффективности
- Сравнение показателей команды
- Периоды: сегодня, неделя, месяц

#### 2.4.3 Отслеживаемые действия
- Взятие диалога (assigned)
- Освобождение диалога (released)
- Передача диалога (transferred)
- Закрытие со статусом

### 2.5 Административная панель

#### 2.5.1 Управление пользователями
- Просмотр всех пользователей
- Изменение ролей
- Активация/деактивация аккаунтов
- Фильтрация и поиск

#### 2.5.2 Управление магазинами
- Список всех магазинов
- Одобрение новых магазинов
- Блокировка магазинов
- Просмотр статистики

### 2.6 Панель владельца магазина ✨ NEW

#### 2.6.1 Управление командой
- Приглашение менеджеров через инвайт-коды
- Просмотр списка менеджеров
- Удаление менеджеров из команды

#### 2.6.2 Управление инвайт-кодами
- Создание новых кодов
- Просмотр активных кодов
- Отзыв кодов
- История использования

#### 2.6.3 Аналитика команды
- Общая статистика по магазину
- Эффективность каждого менеджера
- Распределение нагрузки

## 3. Технические требования

### 3.1 Архитектура

#### Backend
- **Язык**: TypeScript/Node.js
- **Фреймворк**: Express.js
- **ORM**: Prisma
- **БД**: PostgreSQL
- **Кеш**: Redis
- **Real-time**: Socket.IO
- **Валидация**: Zod

#### Frontend
- **Фреймворк**: React 19 + TypeScript
- **Сборка**: Vite
- **Стили**: Tailwind CSS
- **UI Kit**: @chatscope/chat-ui-kit-react
- **Состояние**: React Context API
- **Real-time**: Socket.IO Client

### 3.2 Безопасность ✨ NEW

#### 3.2.1 Rate Limiting
- Общие запросы: 100/15 мин
- Аутентификация: 5/15 мин
- Создание ресурсов: 10/час
- Отправка сообщений: 30/мин
- Роли: админы x10, владельцы x2

#### 3.2.2 CSRF Protection
- Double-submit cookie pattern
- Автоматическое обновление токенов
- Исключения для webhooks

#### 3.2.3 Валидация данных
- Zod схемы для всех endpoint'ов
- Санитизация входных данных
- Проверка типов файлов при загрузке

### 3.3 API Endpoints

#### Аутентификация
- `POST /api/auth/login` - инициация входа
- `POST /api/auth/verify` - верификация кода
- `POST /api/auth/logout` - выход
- `GET /api/auth/me` - текущий пользователь

#### Диалоги
- `GET /api/dialogs` - список диалогов
- `GET /api/dialogs/:id` - детали диалога
- `GET /api/dialogs/:id/messages` - сообщения
- `POST /api/dialogs/:id/messages` - отправка сообщения
- `PATCH /api/dialogs/:id/status` - изменение статуса
- `POST /api/dialogs/:id/claim` - взять диалог ✨ NEW
- `POST /api/dialogs/:id/release` - освободить диалог ✨ NEW
- `POST /api/dialogs/:id/transfer` - передать диалог ✨ NEW
- `GET /api/dialogs/:id/avatar` - аватар клиента ✨ NEW

#### Аналитика ✨ NEW
- `GET /api/analytics/personal` - персональная статистика
- `GET /api/analytics/comparison` - сравнение менеджеров

#### Администрирование
- `GET /api/admin/users` - список пользователей
- `PUT /api/admin/users/:id/role` - изменение роли
- `PUT /api/admin/users/:id/status` - изменение статуса
- `GET /api/admin/shops` - список магазинов
- `PUT /api/admin/shops/:id/approve` - одобрение магазина

#### Управление магазином
- `POST /api/shops` - создание магазина
- `GET /api/shops/:id` - информация о магазине
- `PUT /api/shops/:id` - обновление магазина
- `DELETE /api/shops/:id` - удаление магазина
- `GET /api/shops/:id/dialogs` - диалоги магазина

#### Инвайт-коды ✨ NEW
- `GET /api/invites` - список кодов
- `POST /api/invites` - создание кода
- `DELETE /api/invites/:id` - отзыв кода
- `GET /api/invites/validate/:code` - проверка кода

#### Файлы ✨ NEW
- `POST /api/upload` - загрузка файла
- `GET /api/files/:id` - получение файла

### 3.4 WebSocket События

#### События от сервера
- `new-message` - новое сообщение в диалоге
- `dialog-updated` - обновление диалога
- `dialog-assigned` - диалог назначен ✨ NEW
- `dialog-released` - диалог освобожден ✨ NEW

#### События от клиента
- `join-shop` - присоединение к каналу магазина
- `leave-shop` - выход из канала

## 4. Нефункциональные требования

### 4.1 Производительность
- Время ответа API < 200мс
- Поддержка 100+ одновременных подключений
- Обработка 1000+ сообщений/минуту

### 4.2 Надежность
- Uptime 99.9%
- Автоматическое переподключение WebSocket
- Retry механизм для критических операций

### 4.3 Масштабируемость
- Горизонтальное масштабирование backend
- Кеширование часто используемых данных
- Оптимизация запросов к БД

### 4.4 Удобство использования
- Интуитивный интерфейс
- Адаптивный дизайн
- Поддержка горячих клавиш
- Уведомления о новых сообщениях

## 5. Этапы реализации

### Этап 1: MVP ✅ COMPLETED
- [x] Базовая аутентификация
- [x] Создание магазинов
- [x] Обработка диалогов
- [x] Отправка/получение сообщений

### Этап 2: Расширенный функционал ✅ COMPLETED
- [x] Система ролей и прав
- [x] Назначение диалогов
- [x] Базовая аналитика
- [x] Инвайт-коды

### Этап 3: Оптимизация ✅ COMPLETED
- [x] Rate limiting
- [x] CSRF защита
- [x] Поддержка медиафайлов
- [x] UI/UX улучшения

### Этап 4: Продакшен 🚧 IN PROGRESS
- [ ] Полная документация
- [ ] Deployment скрипты
- [ ] Мониторинг и логирование
- [ ] Backup стратегия

## 6. Ограничения

### 6.1 Технические ограничения
- Максимальный размер файла: 50MB
- Поддерживаемые форматы: jpg, png, pdf, doc, mp4, mp3
- Максимальная длина сообщения: 4096 символов

### 6.2 Бизнес-ограничения
- Один пользователь = один магазин (для роли OWNER)
- Менеджер может работать в нескольких магазинах
- Регистрация только по инвайт-коду

## 7. Риски и их минимизация

### 7.1 Технические риски
- **Риск**: Блокировка Telegram API
  - **Решение**: Rate limiting, очереди сообщений
  
- **Риск**: Потеря данных
  - **Решение**: Регулярные бэкапы, транзакции

### 7.2 Бизнес-риски
- **Риск**: Несанкционированный доступ
  - **Решение**: Инвайт-коды, роли, аудит

## 8. Критерии приемки

### 8.1 Функциональные критерии
- Все API endpoints работают согласно спецификации
- Интерфейс отображается корректно на всех устройствах
- Real-time обновления работают без задержек
- Система обрабатывает все типы медиа

### 8.2 Качественные критерии
- Код покрыт типами TypeScript на 100%
- Отсутствуют критические уязвимости безопасности
- Производительность соответствует требованиям
- Документация полная и актуальная

---

**Версия документа**: 2.0
**Дата обновления**: 2024-08-04
**Статус проекта**: 85% завершен, готов к MVP деплою