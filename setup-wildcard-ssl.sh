#!/bin/bash

echo "üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ wildcard SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è *.gramchat.ru"

ssh root@217.198.6.80 << 'ENDSSH'
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ certbot
    if ! command -v certbot &> /dev/null; then
        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ certbot..."
        apt-get update
        apt-get install -y certbot python3-certbot-nginx python3-certbot-dns-cloudflare
    fi

    echo "üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è wildcard —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
    echo ""
    echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –î–ª—è wildcard —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è DNS –≤–∞–ª–∏–¥–∞—Ü–∏—è!"
    echo "–í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å TXT –∑–∞–ø–∏—Å–∏ –≤ DNS –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞."
    echo ""
    
    # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è wildcard —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —Å DNS –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
    certbot certonly \
        --manual \
        --preferred-challenges dns \
        --server https://acme-v02.api.letsencrypt.org/directory \
        --manual-public-ip-logging-ok \
        --domains "gramchat.ru,*.gramchat.ru" \
        --email admin@gramchat.ru \
        --agree-tos \
        --no-eff-email

    # –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    if [ $? -eq 0 ]; then
        echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!"
        echo "üìÅ –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:"
        echo "   –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: /etc/letsencrypt/live/gramchat.ru/fullchain.pem"
        echo "   –ö–ª—é—á: /etc/letsencrypt/live/gramchat.ru/privkey.pem"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx
        echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        nginx -t
        
        if [ $? -eq 0 ]; then
            systemctl reload nginx
            echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω —Å –Ω–æ–≤—ã–º–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏!"
        fi
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        echo "‚è∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
        
        # –î–æ–±–∞–≤–ª—è–µ–º cron –∑–∞–¥–∞—á—É –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        (crontab -l 2>/dev/null; echo "0 3 * * * certbot renew --quiet --post-hook 'systemctl reload nginx'") | crontab -
        
        echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ!"
        echo ""
        echo "üìù –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 60 –¥–Ω–µ–π"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–æ–±–∞–≤–∏–ª–∏ DNS –∑–∞–ø–∏—Å–∏"
    fi
ENDSSH

echo ""
echo "üéØ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DNS API (–µ—Å–ª–∏ –≤–∞—à DNS –ø—Ä–æ–≤–∞–π–¥–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è):"
echo ""
echo "–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π DNS –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:"
echo "  - Cloudflare: certbot-dns-cloudflare"
echo "  - Route53: certbot-dns-route53"
echo "  - DigitalOcean: certbot-dns-digitalocean"
echo "  –∏ –¥—Ä—É–≥–∏–µ..."