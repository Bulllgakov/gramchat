#!/bin/bash

echo "üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Docker..."

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
cat nginx-production.conf | ssh root@217.198.6.80 "cat > /etc/nginx/sites-available/gramchat"

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
ssh root@217.198.6.80 << 'ENDSSH'
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    nginx -t
    
    if [ $? -eq 0 ]; then
        # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
        systemctl reload nginx
        echo "‚úÖ Nginx —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω!"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
        systemctl status nginx | head -n 5
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx!"
        exit 1
    fi
ENDSSH

echo "‚ú® –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://web.gramchat.ru"